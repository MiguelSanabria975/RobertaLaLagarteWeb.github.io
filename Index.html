<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />

    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"
    />

    <title>MindAR WebAR Multicapas + Multitarget</title>

    <!-- Librerías -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-three.prod.js"></script>

    <style>
      :root {
        --vh: 1vh;
      }
      body {
        margin: 0;
        overflow: hidden;
      }
      #ar-container {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;
        height: calc(var(--vh) * 100);
      }
    </style>
  </head>

  <body>
    <div id="ar-container"></div>

    <script type="module">
      /* ------------ Ajuste de altura “real” (FIX 100vh) ------------- */
      function fixVH() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty("--vh", `${vh}px`);
      }
      fixVH();
      window.addEventListener("resize", fixVH);
      window.addEventListener("orientationchange", fixVH);

      /* Detectar rendimiento */
      function detectarCalidad() {
        const memoria = navigator.deviceMemory || 2; // Default 2 GB
        const cpu = navigator.hardwareConcurrency || 2; // Default 2 cores
        if (memoria <= 2 || cpu <= 4) return "low";
        if (memoria <= 4) return "mid";
        return "hd";
      }
      const calidad = detectarCalidad();
      console.log("Calidad detectada:", calidad);

      /* Shader para croma */

      const makeChromaMaterial = (texture, key = 0x0f00da) => {
        const col = new THREE.Color(key);
        return new THREE.ShaderMaterial({
          uniforms: {
            map: { value: texture },
            keyColor: { value: col },
            similarity: { value: 0.15 },
            smoothness: { value: 0.6 },
          },
          transparent: true,
          vertexShader: `
                  varying vec2 vUv;
                  void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
                  }
                `,
          fragmentShader: `
                  uniform sampler2D map;
                  uniform vec3 keyColor;
                  uniform float similarity;
                  uniform float smoothness;
                  varying vec2 vUv;
                  void main() {
                    vec4 tex = texture2D(map, vUv);
                    float Y = dot(tex.rgb, vec3(0.2989, 0.5866, 0.1145));
                    float Cr = tex.r - Y;
                    float Cb = tex.b - Y;
                    float Yk = dot(keyColor.rgb, vec3(0.2989,0.5866,0.1145));
                    float Crk = keyColor.r - Yk;
                    float Cbk = keyColor.b - Yk;
                    float diff = distance(vec2(Cr,Cb), vec2(Crk,Cbk));
                    float alpha = smoothstep(similarity, similarity+smoothness, diff);
                    gl_FragColor = vec4(tex.rgb, alpha);
                  }
                `,
        });
      };

      /* ============================
         FUNCIONES DE PARTÍCULAS
         Aquí se están creando varias funciones para tener un estandar en la particulas
      ============================ */

      function createRainParticles({
        count = 50,
        areaY = 0.5,
        speed = 0.01,
        color = 0xffffff,
        depthX = 0.1, //control de profundidad en Z
        depthZ = 0.2, //control de profundidad en Z
        position = { x: 0, y: 0, z: 0 }, //posición global configurable
      }) {
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(count * 3);

        for (let i = 0; i < count; i++) {
          positions[i * 3] = (Math.random() - 0.5) * depthX;
          positions[i * 3 + 1] = Math.random() * areaY;
          positions[i * 3 + 2] = (Math.random() - 0.5) * 0.3;
        }

        geometry.setAttribute(
          "position",
          new THREE.BufferAttribute(positions, 3)
        );

        const material = new THREE.PointsMaterial({
          size: 15,
          color: color,
          transparent: true,
          opacity: 0.8,
          depthWrite: false,
        });

        const points = new THREE.Points(geometry, material);
        points.position.set(position.x || 0, position.y || 0, position.z || 0);
        points.userData = { type: "rain", speed, areaY, depthX, depthZ };
        return points;
      }

      function createFoamParticles({
        count = 50,
        areaY = 0.3,
        areaX = 1,
        speed = 0.002,
        color = 0x33cfff,
        depthX = 0.8, // control de profundidad en Z
        depthZ = 0.02, // control de profundidad en Z
        position = { x: 0, y: 0, z: 0 }, // posición global configurable
      }) {
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(count * 3);

        for (let i = 0; i < count; i++) {
          positions[i * 3] = (Math.random() - 0.5) * depthX;
          positions[i * 3 + 1] = (Math.random() - 0.5) * areaY;
          positions[i * 3 + 2] = (Math.random() - 0.5) * depthZ;
        }

        geometry.setAttribute(
          "position",
          new THREE.BufferAttribute(positions, 3)
        );

        const material = new THREE.PointsMaterial({
          size: 10,
          color: color,
          transparent: true,
          opacity: 0.9,
          depthWrite: false,
        });

        const points = new THREE.Points(geometry, material);
        points.position.set(position.x || 0, position.y || 0, position.z || 0);
        points.userData = { type: "foam", speed, areaY, areaX, depthZ, depthX };
        return points;
      }

      function createDragonflyParticles({
        count = 10,
        color = 0xffcc00,
        areaY = 0.3,
        areaX = 1,
        //speed = 0.002,
        depthZ = 0.02,
        position = { x: 0, y: 0, z: 0 }, // posición global configurable
      }) {
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(count * 3);

        for (let i = 0; i < count; i++) {
          positions[i * 3] = (Math.random() - 0.5) * areaX;
          positions[i * 3 + 1] = (Math.random() - 0.5) * areaY;
          positions[i * 3 + 2] = (Math.random() - 0.5) * depthZ;
        }

        geometry.setAttribute(
          "position",
          new THREE.BufferAttribute(positions, 3)
        );

        const material = new THREE.PointsMaterial({
          size: 20,
          color: color,
          transparent: true,
          opacity: 0.9,
          depthWrite: false,
        });

        const points = new THREE.Points(geometry, material);
        points.position.set(position.x || 0, position.y || 0, position.z || 0);
        points.userData = { type: "dragonfly", areaY, areaX, depthZ };
        return points;
      }

      function createFireParticles({
        count = 30,
        areaX = 0.25,
        areaY = 0.25,
        color = 0xff3300,
        position = { x: 0, y: 0, z: 0 }, // posición global configurable
      }) {
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(count * 3);

        for (let i = 0; i < count; i++) {
          positions[i * 3] = (Math.random() - 0.5) * areaX;
          positions[i * 3 + 1] = Math.random() * areaY;
          positions[i * 3 + 2] = (Math.random() - 0.5) * 0.5;
        }

        geometry.setAttribute(
          "position",
          new THREE.BufferAttribute(positions, 3)
        );

        const material = new THREE.PointsMaterial({
          size: 20,
          color: color,
          transparent: true,
          opacity: 0.9,
          depthWrite: false,
        });

        const points = new THREE.Points(geometry, material);
        points.position.set(position.x || 0, position.y || 0, position.z || 0);
        points.userData = { type: "fire", areaY, areaX };
        return points;
      }

      /* ---------- MINDAR ---------- */
      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.querySelector("#ar-container"),
        imageTargetSrc: "TargetsMind/targets.mind",

        /* ← suavizado para reducir jitter */
        filterMinCF: 0.05, /////////////////////// AJUSTES
        filterBeta: 0.01,
      });

      const { renderer, scene, camera } = mindarThree;

      /* Geometría compartida */
      const sharedGeometry = new THREE.PlaneGeometry(0.9, 0.8);

      // const anchor0 = mindarThree.addAnchor(0); ////// para borrar si funciona

      /* Definir los targets y sus capas de video */
      const targets = [
        {
          index: 0,
          audio: "Audio/PajarosSingle_ogg.ogg",
          layers: [
            {
              src: "Animations/Video00_ConFondo.mp4",
              z: 0,
              y: 0,
              scale: 1.0,
              chroma: "0xDCCD00",
            },
            {
              src: "Animations/Video00_Titulo.mp4",
              z: 0.1,
              y: 0.1,
              x: -0.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 1,
          audio: "Audio/Sonido_Video01.ogg",
          layers: [
            {
              src: "Animations/Video01_FondoConFondo.mp4",
              z: -0.02,
              scale: 1.1,
              chroma: "0x0f00da",
            },
            {
              src: "Animations/Video01_Mitad.mp4",
              z: 0.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 2,
          audio: "Audio/Sonido_Video02.ogg",
          layers: [
            {
              src: "Animations/Video02.mp4",
              z: 0.1,
              x: -0.05,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },

        {
          index: 3,
          audio: "Audio/Sonido_Video03.ogg",
          layers: [
            {
              src: "Animations/Video03_Mitad.mp4",

              z: 0,
              chroma: "0x0f00da",
            },
            {
              src: "Animations/Video03_Frente.mp4",
              z: 0.1,
              chroma: "0x0f00da",
            } /* ← antes 0.2 */,
          ],
        },
        {
          index: 4,
          audio: "Audio/Sonido_Video04.ogg",
          layers: [
            { src: "Animations/Video04.mp4", z: 0.2, chroma: "0x0f00da" },
          ],
        },
        {
          index: 5,
          audio: "Audio/Sonido_Video05.ogg",
          layers: [
            {
              src: "Animations/Video05_ConFondo.mp4",
              z: 0.2,
              scale: 1.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 6,
          audio: "Audio/Sonido_Video06.ogg",
          layers: [
            {
              src: "Animations/Video06_Fondo.mp4",
              z: 0.02,
              x: -0.08,
              scale: 1.2,
              chroma: "0x0f00da",
            },
            {
              src: "Animations/Video06_Frente.mp4",
              z: 0.08,
              x: -0.08,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 7,
          audio: "Audio/Sonido_Video07.ogg",
          layers: [
            { src: "Animations/Video07.mp4", z: 0.2, chroma: "0x0f00da" },
          ],
        },
        {
          index: 8,
          audio: "Audio/Sonido_Video07.ogg",
          layers: [
            {
              src: "Animations/Video08.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 9,
          audio: "Audio/Sonido_Video07.ogg",
          layers: [
            {
              src: "Animations/Video09.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 10,
          audio: "Audio/Sonido_Video10.ogg",
          layers: [
            {
              src: "Animations/Video10.mp4",
              z: 0.02,
              y: 0.1,
              x: 0.1,
              scale: 1.5,
              chroma: "0x0f00da",
            },
          ],
        },

        {
          index: 11,
          audio: "Audio/Sonido_Video11.ogg",
          layers: [
            {
              src: "Animations/Video11.mp4",
              z: 0.1,
              scale: 1.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 12,
          audio: "Audio/Sonido_Video12.ogg",
          layers: [
            { src: "Animations/Video12.mp4", z: 0.1, chroma: "0x0f00da" },
          ],
        },
        {
          index: 13,
          audio: "Audio/Sonido_Video13.ogg",
          layers: [
            { src: "Animations/Video13.mp4", z: 0.1, chroma: "0x0f00da" },
          ],
        },
        {
          index: 14,
          audio: "Audio/Sonido_Video13.ogg",
          layers: [
            {
              src: "Animations/Video14.mp4",
              z: 0,
              y: 0.1,
              scale: 1.3,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 15,
          audio: "Audio/Sonido_Video15.ogg",
          layers: [
            {
              src: "Animations/Video15.mp4",
              z: 0,
              x: -0.1,
              y: 0.1,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },

        {
          index: 16,
          audio: "Audio/Sonido_Video16.ogg",
          layers: [
            {
              src: "Animations/Video16.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 17,
          audio: "Audio/Sonido_Video13.ogg",
          layers: [
            {
              src: "Animations/Video17.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 18,
          audio: "Audio/Sonido_Video18.ogg",
          layers: [{ src: "Animations/Video18.mp4", z: 0, chroma: "0x0f00da" }],
        },
        {
          index: 19,
          audio: "Audio/Sonido_Video19.ogg",
          layers: [{ src: "Animations/Video19.mp4", z: 0, chroma: "0x0f00da" }],
        },
        {
          index: 20,
          audio: "Audio/Sonido_Video20.ogg",
          layers: [
            {
              src: "Animations/Video20Fondo.mp4",
              z: 0,
              y: 0.05,
              x: 0.05,
              scale: 1.2,
              chroma: "0x0f00da",
            },
            {
              src: "Animations/Video20Frente.mp4",
              z: 0.2,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 21,
          audio: "Audio/Sonido_Video04.ogg",
          layers: [{ src: "Animations/Video21.mp4", z: 0, chroma: "0x0f00da" }],
        },
        {
          index: 22,
          audio: "Audio/Sonido_Video22.ogg",
          layers: [
            {
              src: "Animations/Video22.mp4",
              z: 0,
              y: 0.15,
              scale: 1.05,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 23,
          audio: "Audio/PajarosSingle_ogg.ogg",
          layers: [{ src: "Animations/Video23.mp4", z: 0, chroma: "0x0f00da" }],
        },
        {
          index: 24,
          audio: "Audio/Sonido_Video10.ogg",
          layers: [{ src: "Animations/Video24.mp4", z: 0, chroma: "0x0f00da" }],
        },
        {
          index: 25,
          audio: "Audio/Sonido_Video25.ogg",
          layers: [
            {
              src: "Animations/Video25.mp4",
              z: 0,
              scale: 1.5,
              y: -0.1,
              chroma: "0x0f00da",
            },
          ],
        },

        {
          index: 26,
          audio: "Audio/Sonido_Video22.ogg",
          layers: [{ src: "Animations/Video26.mp4", z: 0, chroma: "0x0f00da" }],
        },
        {
          index: 27,
          audio: "Audio/Sonido_Video27.ogg",
          layers: [
            {
              src: "Animations/Video27.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 28,
          audio: "Audio/Sonido_Video28.ogg",
          layers: [
            {
              src: "Animations/Video28.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 29,
          audio: "Audio/Sonido_Video29.ogg",
          layers: [
            {
              src: "Animations/Video29.mp4",
              z: 0,
              scale: 1.2,
              y: 0.1,
              x: -0.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 30,
          audio: "Audio/PajarosSingle_ogg.ogg",
          layers: [
            {
              src: "Animations/Video30.mp4",
              z: 0.2,
              x: 0,
              y: 0.05,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
      ];

      let particlesRef = null;
      let target1Active = false;

      // Crear los targets y videos
      targets.forEach((target) => {
        const { index, layers, audio: audioSrc } = target;
        const anchor = mindarThree.addAnchor(index);
        target.videos = []; //  guardamos videos aquí
        target.audioObj = null;

        if (target.audio) {
          const audio = new Audio(target.audio);
          audio.loop = true;
          audio.preload = "auto";
          audio.crossOrigin = "anonymous";
          target.audioObj = audio;
        }

        // Función para crear material de video con fallback a imagen
        function createVideoMaterial(src, chroma) {
          const video = document.createElement("video");
          video.src = src;
          video.crossOrigin = "anonymous";
          video.loop = true;
          video.muted = true; // 🔥 obligatorio
          video.playsInline = true; // 🔥 evita fullscreen iOS
          video.autoplay = true;
          video.preload = "auto"; // 🔥 carga anticipada
          video.setAttribute("webkit-playsinline", "true"); // compatibilidad iOS

          // Dispara play al cargar
          video.addEventListener("canplaythrough", () => {
            video
              .play()
              .catch((e) => console.log("No pudo iniciar autoplay:", e));
          });

          const texture = new THREE.VideoTexture(video);
          texture.minFilter = THREE.LinearFilter;
          texture.magFilter = THREE.LinearFilter;
          texture.format = THREE.RGBAFormat;

          let material;
          if (chromaKey) {
            const key = Number(chromaKey.replace("#", "0x"));
            material = makeChromaMaterial(texture, key);
          } else {
            material = new THREE.MeshBasicMaterial({ map: texture });
          }

          // Fallback: si no carga video, usar imagen
          video.onerror = () => {
            console.warn(
              `⚠️ No se pudo cargar ${src}, usando imagen fallback.`
            );
            const imgTexture = new THREE.TextureLoader().load(
              src.replace(".mp4", ".jpg"), // Imagen de respaldo
              () => {
                material.map = imgTexture;
                material.needsUpdate = true;
              }
            );
          };

          // Intentar reproducir al estar listo
          video.oncanplaythrough = () => {
            video.play().catch((err) => {
              console.warn("⚠️ No se pudo reproducir automáticamente:", err);
            });
          };

          return { material, video };
        }

        /* ============================
          MAPA DE CONFIG POR TARGET
        ============================ */
        const particleTypes = {
          rain: createRainParticles,
          foam: createFoamParticles,
          dragonfly: createDragonflyParticles,
          fire: createFireParticles,
        };

        /* ============================
          ASIGNACION DE PARTICULAS POR TARGET
        ============================ */
        const targetParticleConfig = {
          0: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.2,
              areaX: 5,
              speed: 0.0002, // Velocidad baja
              size: 1000, // Tamaño de partícula
              color: 0xffff, // Blanco visible
              position: { x: 0, y: -0.25, z: 0.1 },
            },
          },
          1: {
            type: "rain",
            params: {
              count: 300,
              areaY: 0.7,
              depthX: 1,
              speed: 0.005,
              size: 0.01,
              color: 0x3642fa,
            },
          },
          2: {
            type: "dragonfly",
            params: {
              count: 100,
              size: 0.025,
              color: 0xc020fa,
              speed: 0.5,
              areaX: 0.8,
            },
          },
          3: {
            type: "rain",
            params: {
              count: 300,
              areaY: 0.7,
              depthX: 1,
              speed: 0.005,
              size: 0.01,
              color: 0x3642fa,
            },
          },
          4: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.2,
              areaX: 5,
              speed: 0.001, // Velocidad baja
              size: 50, // Tamaño de partícula
              color: 0xffff, // Blanco visible
              position: { x: 0, y: -0.25, z: 0.1 },
            },
          },
          5: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.7,
              areaX: 5,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xffff, // Blanco visible
              position: { x: 0, y: 0.1, z: 0.2 },
            },
          },
          11: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.7,
              areaX: 5,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xF00111, // Blanco visible
              position: { x: 0, y: 0.1, z: 0.2 },
            },
          },
          12: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.7,
              areaX: 5,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xF00111, // Blanco visible
              position: { x: 0, y: 0.1, z: 0.2 },
            },
          },
          13: {
            type: "fire",
            params: {
              count: 50,
              areaY: 0.3,
              speed: 0.0008,
              size: 0.001,
              color: 0xff3300,
              position: { x: 0.18, y: -0.14, z: 0.2 },
            },
          },
          14: {
            type: "fire",
            params: {
              count: 50,
              areaY: 0.3,
              size: 0.02,
              color: 0xff3300,
              position: { x: 0.1, y: 0, z: -0.1 },
            },
          },
          15: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.7,
              areaX: 5,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xff3300, // Blanco visible
              position: { x: 0, y: 0.1, z: 0.2 },
            },
          },
          16: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.7,
              areaX: 5,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xff3300, // Blanco visible
              position: { x: 0, y: 0.1, z: 0.2 },
            },
          },
          17: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.7,
              areaX: 5,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xff3300, // Blanco visible
              position: { x: 0, y: 0.1, z: 0.2 },
            },
          },
          19: {
            type: "fire",
            params: {
              count: 50,
              areaY: 0.1,
              size: 0.01,
              color: 0xff3300,
              position: { x: -0.08, y: -0.05, z: 0.2 },
            },
          },
          20: {
            type: "rain",
            params: {
              count: 300,
              areaY: 0.7,
              depthX: 1,
              speed: 0.005,
              size: 0.01,
              color: 0x3642fa,
              position: { x:0, y: 0, z: 0.3 },
            },
          },
          24: {
            type: "rain",
            params: {
              count: 300,
              areaY: 0.7,
              depthX: 1,
              speed: 0.0005,
              size: 0.001,
              color: 0x9B3496,
              position: { x:0, y: 0, z: -0.1 },
            },
          },
          25: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.4,
              areaX: 10,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xfff, // Blanco visible
              position: { x: 0, y: -0.2, z: 0.2 },
            },
          },
          28: {
            type: "rain",
            params: {
              count: 300,
              areaY: 0.7,
              depthX: 1,
              speed: 0.0005,
              size: 1000,
              color: 0x9B3496,
              position: { x:0, y: 0, z: -0.1 },
            },
          },
          29: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.8,
              areaX: 10,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xfff, // Blanco visible
              position: { x: 0, y: 0, z: 0.2 },
            },
          },
          30: {
            type: "foam",
            params: {
              count: 300,
              areaY: 0.8,
              areaX: 10,
              speed: 0.0008, // Velocidad baja
              size: 100, // Tamaño de partícula
              color: 0xfce733, // Blanco visible
              position: { x: 0, y: -0.12, z: -0.1 },
            },
          },

        };

        // Ajuates de las capas de video

        layers.forEach(({ src, z, x = 0, y = 0, scale = 1, chroma }) => {
          const videoElement = document.createElement("video");
          videoElement.crossOrigin = "anonymous";
          videoElement.loop = true;
          videoElement.muted = true; // 🔥 necesario para autoplay
          videoElement.playsInline = true;
          videoElement.autoplay = false;
          videoElement.preload = "auto";
          videoElement.src = src;

          // Guardamos referencia
          target.videos.push(videoElement);

          const texture = new THREE.VideoTexture(videoElement);
          texture.minFilter = THREE.LinearFilter;
          texture.magFilter = THREE.LinearFilter;

          const geometry = new THREE.PlaneGeometry(0.9, 0.8);
          const uv = geometry.attributes.uv.array;
          uv[0] = 0.01; // U min
          uv[2] = 0.99; // U max
          uv[4] = 0.01;
          uv[6] = 0.99;
          geometry.attributes.uv.needsUpdate = true;

          /* ⇣ decide material según 'chroma' */
          let material;

          if (typeof chroma === "string" && chroma) {
            const key = Number(chroma.replace("#", "0x"));
            material = makeChromaMaterial(texture, key);
          } else {
            material = new THREE.MeshBasicMaterial({ map: texture });
          }

          const plane = new THREE.Mesh(geometry, material);
          plane.position.set(x, y, z);
          plane.scale.set(scale, scale, 1);
          anchor.group.add(plane);
        });

        // Eventos target (CUANDO ENCUENTRA EL TARGET)
        anchor.onTargetFound = () => {
          target.videos.forEach((v) => {
            v.play().catch(() => {});
          });
          if (target.audioObj) target.audioObj.play().catch(() => {});
        };

        // 🌟 Crear partículas SOLO si están configuradas
        const config = targetParticleConfig[index];
        if (config) {
          const particleSystem = particleTypes[config.type](config.params);
          particleSystem.userData = { type: config.type, ...config.params };
          anchor.group.add(particleSystem);
          target.particlesRef = particleSystem;
        }

        // Eventos target (CUANDO SE PIERDE EL TARGET)
        anchor.onTargetLost = () => {
          target.videos.forEach((v) => v.pause());
          if (target.audioObj) target.audioObj.pause();
        };

        /* Precarga en iPhone: desbloquear video+audio */
        document.body.addEventListener(
          "touchstart",
          () => {
            targets.forEach((t) => {
              t.videos.forEach((v) => {
                v.play()
                  .then(() => {
                    v.pause();
                    v.currentTime = 0.01; // precalienta primer frame
                  })
                  .catch(() => {});
              });
              if (t.audioObj) {
                t.audioObj
                  .play()
                  .then(() => {
                    t.audioObj.pause();
                    t.audioObj.currentTime = 0;
                  })
                  .catch(() => {});
              }
            });
          },
          { once: true }
        );
      });

      /* ============================
        ANIMACIÓN CENTRALIZADA

        Aquí se animarian las particulas
         ============================ */
      function animateParticles() {
        const t = performance.now() * 0.001;

        targets.forEach((target) => {
          const pRef = target.particlesRef;
          if (!pRef || !pRef.geometry || !pRef.userData) return;

          const positions = pRef.geometry.attributes.position.array;
          const data = pRef.userData;
          const count = positions.length / 3;

          switch (data.type) {
            case "rain": {
              const velocities = data.velocities || [];
              for (let i = 0; i < count; i++) {
                const idx = i * 3;
                positions[idx + 1] += velocities[i] || -data.speed;
                if (positions[idx + 1] < -data.areaY / 2) {
                  positions[idx + 1] = data.areaY / 2;
                }
              }
              break;
            }

            case "foam": {
              const velocities = data.velocities || [];
              for (let i = 0; i < count; i++) {
                const idx = i * 3;
                positions[idx + 1] += velocities[i] || data.speed;
                if (positions[idx + 1] > data.areaY / 2) {
                  positions[idx + 1] = -data.areaY / 2;
                }
              }
              break;
            }

            case "dragonfly": {
              const positions = pRef.geometry.attributes.position.array;
              const data = pRef.userData;
              const count = positions.length / 3;

              for (let i = 0; i < count; i++) {
                const idx = i * 3;

                // Oscilación horizontal + desplazamiento
                positions[idx] += Math.sin(t + i) * data.speed * 0.01;
                positions[idx + 1] += Math.cos(t + i) * data.speed * 0.005;

                // Opcional: limitar posición en X/Y para que no se vayan muy lejos
                if (positions[idx] > data.areaX / 2)
                  positions[idx] = -data.areaX / 2;
                if (positions[idx] < -data.areaX / 2)
                  positions[idx] = data.areaX / 2;
                if (positions[idx + 1] > data.areaY / 2)
                  positions[idx + 1] = -data.areaY / 2;
                if (positions[idx + 1] < -data.areaY / 2)
                  positions[idx + 1] = data.areaY / 2;
              }

              pRef.geometry.attributes.position.needsUpdate = true;
              break;
            }

            case "fire": {
              const velocities = data.velocities || [];
              for (let i = 0; i < count; i++) {
                const idx = i * 3;
                positions[idx + 1] += velocities[i] || 0.003;
                if (positions[idx + 1] > data.areaY) {
                  positions[idx + 1] = 0;
                }
              }
              break;
            }
          }

          pRef.geometry.attributes.position.needsUpdate = true;
        });
      }

      const start = async () => {
        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          animateParticles();
          renderer.render(scene, camera);
        });
      };
      start();
    </script>
  </body>
</html>
