<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"
    />
    <title>WebAR (AAC + AutoStart + Splash + Fix Android Low-End)</title>

    <!-- Preload del icono (cambia la ruta por la tuya) -->
    <link rel="preload" as="image" href="Img/IconSound.png" />

    <!-- Librerías -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-three.prod.js"></script>

    <style>
      :root {
        --vh: 1vh;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
      }
      #ar-container {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;
        height: calc(var(--vh) * 100);
      }
      #fps {
        position: fixed;
        right: 0.5rem;
        bottom: 0.5rem;
        color: #9ad;
        font: 12px/1 system-ui;
        opacity: 0.85;
      }

      /* SPLASH de icono a pantalla completa */
      #splash {
        position: fixed;
        inset: 0;
        z-index: 20;
        display: grid;
        place-items: center;
        background: rgba(0, 0, 0, 0.55);
        opacity: 0;
        pointer-events: none;
        transition: opacity 220ms ease;
        -webkit-tap-highlight-color: transparent;
      }
      #splash.show {
        opacity: 1;
        pointer-events: auto;
      }
      #splash .icon {
        width: min(64vmin, 420px);
        aspect-ratio: 1 / 1;
        background: center / contain no-repeat;
        image-rendering: -webkit-optimize-contrast;
        will-change: transform, opacity;
        animation: pop 320ms ease both;
      }
      @keyframes pop {
        from {
          transform: scale(0.92);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div id="ar-container"></div>
    <div id="fps" aria-hidden="true"></div>
    <div id="splash" aria-hidden="false">
      <div class="icon" id="splash-icon"></div>
    </div>

    <script type="module">
      /* ================= CONFIG ================= */
      const SPLASH_ICON_URL = "Img/IconSound.png"; // ← cambia a tu PNG
      const SPLASH_DURATION_MS = 1000; // 1s visible

      /* ====== FIX 100vh iOS ====== */
      const fixVH = () => {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty("--vh", `${vh}px`);
      };
      fixVH();
      addEventListener("resize", fixVH);
      addEventListener("orientationchange", fixVH);

      /* ====== Perfil de calidad ====== */
      const detectarCalidad = () => { // metodo para detectar device
        // true iphone metodo para abrir iphone
        const mem = navigator.deviceMemory || 2;
        const cpu = navigator.hardwareConcurrency || 2;
        if (mem <= 2 || cpu <= 4) return "low"; // en ipphone da 0, firefox for developer
        if (mem <= 4) return "mid";
        return "hd";
      };
      const calidad = detectarCalidad();
      const ENABLE_PARTICLES = calidad !== "low"; // en low, sin partículas

      /* ====== Partículas con escalado ====== */
      const scaleByQuality = (n) =>
        calidad === "low" ? 0 : calidad === "mid" ? Math.round(n * 0.6) : n;
      const createPoints = (positions, size, color) => {
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute(
          "position",
          new THREE.BufferAttribute(positions, 3)
        );
        const material = new THREE.PointsMaterial({
          size,
          color,
          transparent: true,
          opacity: 0.9,
          depthWrite: false,
        });
        return new THREE.Points(geometry, material);
      };
      const Particles = {
        rain: ({
          count = 50,
          areaY = 0.5,
          speed = 0.01,
          color = 0xffffff,
          depthX = 0.1,
          depthZ = 0.2,
          size = 10,
          position = { x: 0, y: 0, z: 0 },
        }) => {
          count = scaleByQuality(count);
          if (!count) return null;
          const positions = new Float32Array(count * 3);
          for (let i = 0; i < count; i++) {
            positions[i * 3] = (Math.random() - 0.5) * depthX;
            positions[i * 3 + 1] = Math.random() * areaY;
            positions[i * 3 + 2] = (Math.random() - 0.5) * depthZ;
          }
          const p = createPoints(positions, size, color);
          p.position.set(position.x || 0, position.y || 0, position.z || 0);
          p.userData = { type: "rain", speed, areaY };
          return p;
        },
        foam: ({
          count = 50,
          areaY = 0.3,
          areaX = 1,
          speed = 0.002,
          color = 0x33cfff,
          depthX = 0.8,
          depthZ = 0.02,
          size = 10,
          position = { x: 0, y: 0, z: 0 },
        }) => {
          count = scaleByQuality(count);
          if (!count) return null;
          const positions = new Float32Array(count * 3);
          for (let i = 0; i < count; i++) {
            positions[i * 3] = (Math.random() - 0.5) * depthX;
            positions[i * 3 + 1] = (Math.random() - 0.5) * areaY;
            positions[i * 3 + 2] = (Math.random() - 0.5) * depthZ;
          }
          const p = createPoints(positions, size, color);
          p.position.set(position.x || 0, position.y || 0, position.z || 0);
          p.userData = { type: "foam", speed, areaY };
          return p;
        },
        dragonfly: ({
          count = 10,
          color = 0xffcc00,
          areaY = 0.3,
          areaX = 1,
          speed = 0.002,
          depthZ = 0.02,
          size = 10,
          position = { x: 0, y: 0, z: 0 },
        }) => {
          count = scaleByQuality(count);
          if (!count) return null;
          const positions = new Float32Array(count * 3);
          for (let i = 0; i < count; i++) {
            positions[i * 3] = (Math.random() - 0.5) * areaX;
            positions[i * 3 + 1] = (Math.random() - 0.5) * areaY;
            positions[i * 3 + 2] = (Math.random() - 0.5) * depthZ;
          }
          const p = createPoints(positions, size, color);
          p.position.set(position.x || 0, position.y || 0, position.z || 0);
          p.userData = { type: "dragonfly", areaX, areaY, speed };
          return p;
        },
        fire: ({
          count = 30,
          areaX = 0.25,
          areaY = 0.25,
          speed = 0.002,
          color = 0xff3300,
          size = 10,
          position = { x: 0, y: 0, z: 0 },
        }) => {
          count = scaleByQuality(count);
          if (!count) return null;
          const positions = new Float32Array(count * 3);
          for (let i = 0; i < count; i++) {
            positions[i * 3] = (Math.random() - 0.5) * areaX;
            positions[i * 3 + 1] = Math.random() * areaY;
            positions[i * 3 + 2] = (Math.random() - 0.5) * 0.5;
          }
          const p = createPoints(positions, size, color);
          p.position.set(position.x || 0, position.y || 0, position.z || 0);
          p.userData = { type: "fire", speed, areaY };
          return p;
        },
      };

      /* ====== Shader de croma (con precision para Android) ====== */
      const makeChromaMaterial = (texture, key = 0x0f00da) => {
        const col = new THREE.Color(key);
        return new THREE.ShaderMaterial({
          uniforms: {
            map: { value: texture },
            keyColor: { value: col },
            similarity: { value: 0.15 },
            smoothness: { value: 0.6 },
          },
          transparent: true,
          vertexShader: `
            precision mediump float; // <- importante para Android
            varying vec2 vUv;
            void main(){ vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0); }
          `,
          fragmentShader: `
            precision mediump float; // <- importante para Android
            uniform sampler2D map; uniform vec3 keyColor; uniform float similarity; uniform float smoothness; varying vec2 vUv;
            void main(){
              vec4 tex = texture2D(map, vUv);
              float Y = dot(tex.rgb, vec3(0.2989, 0.5866, 0.1145));
              float Cr = tex.r - Y; float Cb = tex.b - Y;
              float Yk = dot(keyColor.rgb, vec3(0.2989,0.5866,0.1145));
              float Crk = keyColor.r - Yk; float Cbk = keyColor.b - Yk;
              float diff = distance(vec2(Cr,Cb), vec2(Crk,Cbk));
              float alpha = smoothstep(similarity, similarity+smoothness, diff);
              gl_FragColor = vec4(tex.rgb, alpha);
            }
          `,
        });
      };

      /* ====== MindAR ====== */
      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.querySelector("#ar-container"),
        imageTargetSrc: "TargetsMind/targets.mind",
        filterMinCF: 0.05,
        filterBeta: 0.01,
      });
      const { renderer, scene, camera } = mindarThree;

      // Pixel ratio más agresivo en low-end
      const pxr = calidad === "low" ? 0.75 : calidad === "mid" ? 1.0 : 1.25;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, pxr));
      if (renderer.outputEncoding !== undefined)
        renderer.outputEncoding = THREE.sRGBEncoding;
      try {
        renderer.getContext().getContextAttributes().powerPreference =
          "low-power";
      } catch (e) {}

      // Geometría compartida
      const sharedPlane = new THREE.PlaneGeometry(0.9, 0.8);

      /* ====== SOLO AAC (.m4a) ====== */
      const pickAAC = (basePath) => `${basePath}.m4a`;

      /* ====== Definición de targets ====== */
      const targets = [
        {
          index: 0,
          audioBase: "Audio/PajarosSingle",
          layers: [
            {
              src: "Animations/Video00_ConFondo.mp4",
              x: 0.03,
              scale: 0.92,
              chroma: "0xDCCD00",
            },
            {
              src: "Animations/Video00_Titulo.mp4",
              z: 0.1,
              y: 0.1,
              x: -0.01,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 1,
          audioBase: "Audio/SoundVideo01",
          layers: [
            {
              src: "Animations/Video01_FondoConFondo.mp4",
              z: -0.02,
              x: -0.08,
              y: 0.02,
              scale: 0.9,
              chroma: "0x0f00da",
            },
            { src: "Animations/Video01_Mitad.mp4", z: 0.1, chroma: "0x0f00da" },
          ],
        },
        {
          index: 2,
          audioBase: "Audio/Sonido_Video02",
          layers: [
            {
              src: "Animations/Video02.mp4",
              z: 0.1,
              x: -0.05,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 3,
          audioBase: "Audio/Sonido_Video03",
          layers: [
            { src: "Animations/Video03_Mitad.mp4", z: 0, chroma: "0x0f00da" },
            {
              src: "Animations/Video03_Frente.mp4",
              z: 0.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 4,
          audioBase: "Audio/Sonido_Video04",
          layers: [
            {
              src: "Animations/Video04.mp4",
              z: 0.1,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 5,
          audioBase: "Audio/Sonido_Video05",
          layers: [
            {
              src: "Animations/Video05_ConFondo.mp4",
              z: 0.0,
              scale: 1.1,
              x: 0.08,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 6,
          audioBase: "Audio/Sonido_Video06",
          layers: [
            {
              src: "Animations/Video06_Fondo.mp4",
              z: 0.02,
              x: -0.08,
              scale: 1.2,
              chroma: "0x0f00da",
            },
            {
              src: "Animations/Video06_Frente.mp4",
              z: 0.05,
              x: -0.08,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 7,
          audioBase: "Audio/Sonido_Video07",
          layers: [
            { src: "Animations/Video07.mp4", z: 0.2, chroma: "0x0f00da" },
          ],
        },
        {
          index: 8,
          audioBase: "Audio/Sonido_Video07",
          layers: [
            {
              src: "Animations/Video08.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 9,
          audioBase: "Audio/Sonido_Video07",
          layers: [
            {
              src: "Animations/Video09.mp4",
              z: 0,
              y: -0.1,
              scale: 1.0,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 10,
          audioBase: "Audio/Sonido_Video10",
          layers: [
            {
              src: "Animations/Video10.mp4",
              z: 0.02,
              y: 0.1,
              x: 0.1,
              scale: 1.5,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 11,
          audioBase: "Audio/Sonido_Video11",
          layers: [
            {
              src: "Animations/Video11.mp4",
              z: 0.1,
              scale: 1.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 12,
          audioBase: "Audio/Sonido_Video12",
          layers: [
            { src: "Animations/Video12.mp4", z: 0.1, chroma: "0x0f00da" },
          ],
        },
        {
          index: 13,
          audioBase: "Audio/Sonido_Video13",
          layers: [
            { src: "Animations/Video13.mp4", z: 0.1, chroma: "0x0f00da" },
          ],
        },
        {
          index: 14,
          audioBase: "Audio/Sonido_Video13",
          layers: [
            {
              src: "Animations/Video14.mp4",
              z: 0,
              y: 0.1,
              scale: 1.3,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 15,
          audioBase: "Audio/Sonido_Video15",
          layers: [
            {
              src: "Animations/Video15.mp4",
              z: 0,
              x: -0.1,
              y: 0.1,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 16,
          audioBase: "Audio/Sonido_Video16",
          layers: [
            {
              src: "Animations/Video16.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 17,
          audioBase: "Audio/Sonido_Video13",
          layers: [
            {
              src: "Animations/Video17.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 18,
          audioBase: "Audio/Sonido_Video18",
          layers: [
            {
              src: "Animations/Video18.mp4",
              scale: 1.2,
              y: 0.08,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 19,
          audioBase: "Audio/Sonido_Video19",
          layers: [
            { src: "Animations/Video19.mp4", y: -0.08, chroma: "0x0f00da" },
          ],
        },
        {
          index: 20,
          audioBase: "Audio/Sonido_Video20",
          layers: [
            {
              src: "Animations/Video20Fondo.mp4",
              z: 0,
              y: 0.05,
              x: 0.05,
              scale: 1.2,
              chroma: "0x0f00da",
            },
            {
              src: "Animations/Video20Frente.mp4",
              z: 0.2,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 21,
          audioBase: "Audio/Sonido_Video04",
          layers: [{ src: "Animations/Video21.mp4", z: 0, chroma: "0x0f00da" }],
        },
        {
          index: 22,
          audioBase: "Audio/Sonido_Video22",
          layers: [
            {
              src: "Animations/Video22.mp4",
              z: 0,
              y: 0.15,
              scale: 1.05,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 23,
          audioBase: "Audio/PajarosSingle",
          layers: [
            {
              src: "Animations/Video23.mp4",
              scale: 1.1,
              y: 0.02,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 24,
          audioBase: "Audio/Sonido_Video10",
          layers: [
            {
              src: "Animations/Video24.mp4",
              scale: 1.15,
              x: 0.02,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 25,
          audioBase: "Audio/Sonido_Video25",
          layers: [
            {
              src: "Animations/Video25.mp4",
              z: 0,
              scale: 1.5,
              y: -0.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 26,
          audioBase: "Audio/Sonido_Video22",
          layers: [
            {
              src: "Animations/Video26.mp4",
              scale: 0.8,
              y: -0.05,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 27,
          audioBase: "Audio/Sonido_Video27",
          layers: [
            {
              src: "Animations/Video27.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 28,
          audioBase: "Audio/Sonido_Video28",
          layers: [
            {
              src: "Animations/Video28.mp4",
              z: 0,
              scale: 1.2,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 29,
          audioBase: "Audio/Sonido_Video29",
          layers: [
            {
              src: "Animations/Video29.mp4",
              z: 0,
              scale: 1.2,
              y: 0.1,
              x: -0.1,
              chroma: "0x0f00da",
            },
          ],
        },
        {
          index: 30,
          audioBase: "Audio/PajarosSingle",
          layers: [
            {
              src: "Animations/Video30.mp4",
              z: 0.1,
              x: 0.04,
              y: 0,
              scale: 1.1,
              chroma: "0x0f00da",
            },
          ],
        },
      ];

      // Partículas mapeadas (mismo mapa, pero se crean bajo demanda y NO en low)
      const particleMap = {
        0: {
          type: "foam",
          params: {
            count: 300,
            areaY: 0.2,
            areaX: 5,
            speed: 0.0002,
            size: 15,
            color: 0xffff,
            position: { x: 0, y: -0.25, z: 0.1 },
          },
        },
        1: {
          type: "rain",
          params: {
            count: 300,
            areaY: 0.7,
            depthX: 1,
            speed: 0.005,
            size: 7,
            color: 0x3642fa,
          },
        },
        2: {
          type: "dragonfly",
          params: {
            count: 100,
            size: 12,
            color: 0xc020fa,
            speed: 3,
            areaX: 0.7,
            areaY: 0.7,
          },
        },
        3: {
          type: "rain",
          params: {
            count: 300,
            areaY: 0.7,
            depthX: 0.8,
            speed: 0.005,
            size: 10,
            color: 0x3642fa,
          },
        },
        5: {
          type: "foam",
          params: {
            count: 300,
            areaY: 0.6,
            areaX: 6,
            speed: 0.008,
            size: 10,
            color: 0xffff,
            position: { x: 0, y: 0, z: -0.1 },
          },
        },
        11: {
          type: "foam",
          params: {
            count: 200,
            areaY: 0.5,
            areaX: 5,
            speed: 0.0008,
            size: 10,
            color: 0xf00111,
            position: { x: 0, y: 0, z: -0.1 },
          },
        },
        12: {
          type: "foam",
          params: {
            count: 300,
            areaY: 0.7,
            areaX: 5,
            depthZ: -0.5,
            speed: 0.0008,
            size: 10,
            color: 0xf00111,
            position: { x: 0, y: 0.1, z: 0.2 },
          },
        },
        13: {
          type: "fire",
          params: {
            count: 50,
            areaY: 0.3,
            speed: 0.0008,
            size: 0.001,
            color: 0xff3300,
            position: { x: 0.18, y: -0.14, z: 0.2 },
          },
        },
        14: {
          type: "fire",
          params: {
            count: 100,
            areaY: 0.3,
            areaX: 0.5,
            size: 18,
            color: 0xff3300,
            position: { x: 0.1, y: 0, z: -0.1 },
          },
        },
        15: {
          type: "foam",
          params: {
            count: 300,
            areaY: 0.7,
            areaX: 6,
            speed: 0.0008,
            size: 10,
            color: 0xff3300,
            position: { x: 0, y: 0.1, z: -0.1 },
          },
        },
        16: {
          type: "fire",
          params: {
            count: 300,
            areaY: 0.7,
            areaX: 0.7,
            speed: 0.0008,
            size: 10,
            color: 0xff3300,
            position: { x: 0, y: -0.3, z: -0.1 },
          },
        },
        17: {
          type: "foam",
          params: {
            count: 100,
            areaY: 0.9,
            areaX: 0.9,
            speed: 0.0008,
            size: 10,
            color: 0xff3300,
            position: { x: -0.1, y: -0.06, z: -0.1 },
          },
        },
        19: {
          type: "fire",
          params: {
            count: 50,
            areaY: 0.1,
            size: 0.01,
            color: 0xff3300,
            position: { x: -0.08, y: -0.05, z: 0.2 },
          },
        },
        20: {
          type: "rain",
          params: {
            count: 300,
            areaY: 0.7,
            depthX: 1,
            speed: 0.005,
            size: 0.01,
            color: 0x3642fa,
            position: { x: 0, y: 0, z: 0.3 },
          },
        },
        24: {
          type: "fire",
          params: {
            count: 300,
            areaY: 0.7,
            areaX: 0.5,
            speed: 0.0008,
            size: 10,
            color: 0xce88d8,
            position: { x: -0.1, y: -0.3, z: -0.1 },
          },
        },
        25: {
          type: "foam",
          params: {
            count: 300,
            areaY: 0.3,
            areaX: 10,
            speed: 0.0008,
            size: 10,
            color: 0xffff,
            position: { x: 0, y: -0.2, z: 0.2 },
          },
        },
        28: {
          type: "rain",
          params: {
            count: 300,
            areaY: 0.7,
            depthX: 1,
            speed: 0.0005,
            size: 25,
            color: 0x9b3496,
            position: { x: 0, y: -0.2, z: -0.1 },
          },
        },
        29: {
          type: "foam",
          params: {
            count: 300,
            areaY: 0.8,
            areaX: 10,
            speed: 0.0008,
            size: 10,
            color: 0xffff,
            position: { x: 0, y: 0, z: -0.1 },
          },
        },
        30: {
          type: "foam",
          params: {
            count: 100,
            areaY: 0.8,
            areaX: 10,
            speed: 0.0008,
            size: 10,
            color: 0xfce733,
            position: { x: 0, y: 0, z: -0.1 },
          },
        },
      };

      // Estado
      const activeTargets = new Set();
      let audioUnlocked = false;

      /* ====== Helpers: video sin flash negro, y espera de primer frame ====== */
      const waitFirstFrame = (video) =>
        new Promise((resolve) => {
          const done = () => {
            cleanup();
            resolve();
          };
          const cleanup = () => {
            video.removeEventListener("playing", done);
            video.removeEventListener("loadeddata", done);
            video.removeEventListener("seeked", done);
          };
          if (typeof video.requestVideoFrameCallback === "function") {
            video.requestVideoFrameCallback(() => {
              done();
            });
          } else {
            video.addEventListener("playing", done, { once: true });
            video.addEventListener("loadeddata", done, { once: true });
            video.addEventListener("seeked", done, { once: true });
          }
        });
      const primeVideoFrame = async (video) => {
        try {
          await video.play();
        } catch (e) {}
        try {
          video.pause();
        } catch (e) {}
        try {
          video.currentTime = 0.03;
        } catch (e) {}
      };
      const revealOnFirstFrame = (video, mesh) => {
        mesh.visible = false;
        const show = () => {
          mesh.visible = true;
          cleanup();
        };
        const cleanup = () => {
          video.removeEventListener("playing", show);
          video.removeEventListener("seeked", show);
          video.removeEventListener("loadeddata", show);
        };
        if (typeof video.requestVideoFrameCallback === "function") {
          video.requestVideoFrameCallback(() => show());
        } else {
          video.addEventListener("playing", show, { once: true });
          video.addEventListener("seeked", show, { once: true });
          video.addEventListener("loadeddata", show, { once: true });
        }
      };

      const createVideoLayer = (layerCfg) => {
        const { src, z = 0, x = 0, y = 0, scale = 1, chroma } = layerCfg;
        const video = document.createElement("video");
        video.crossOrigin = "anonymous";
        video.loop = true;
        video.muted = true;
        video.playsInline = true;
        video.autoplay = false;
        video.preload = "auto";
        video.setAttribute("playsinline", "");
        video.setAttribute("webkit-playsinline", "true");
        video.disablePictureInPicture = true;
        video.src = src;

        const texture = new THREE.VideoTexture(video);
        texture.minFilter = THREE.LinearFilter;
        texture.magFilter = THREE.LinearFilter;
        if ("colorSpace" in texture) texture.colorSpace = THREE.SRGBColorSpace;
        video.addEventListener("loadeddata", () => {
          texture.needsUpdate = true;
        });

        const geom = sharedPlane.clone();
        const uv = geom.attributes.uv.array;
        uv[0] = 0.01;
        uv[2] = 0.99;
        uv[4] = 0.01;
        uv[6] = 0.99;
        geom.attributes.uv.needsUpdate = true;

        const material =
          typeof chroma === "string" && chroma
            ? makeChromaMaterial(texture, Number(chroma.replace("#", "0x")))
            : new THREE.MeshBasicMaterial({ map: texture, transparent: false });

        const mesh = new THREE.Mesh(geom, material);
        mesh.position.set(x, y, z);
        mesh.scale.set(scale, scale, 1);
        revealOnFirstFrame(video, mesh);
        return { video, texture, mesh };
      };

      const disposeLayer = (layer) => {
        if (!layer) return;
        try {
          layer.video.pause();
        } catch (e) {}
        if (layer.texture) {
          layer.texture.dispose();
        }
        if (layer.mesh) {
          if (layer.mesh.material?.map?.dispose)
            layer.mesh.material.map.dispose();
          if (layer.mesh.material?.dispose) layer.mesh.material.dispose();
          if (layer.mesh.geometry?.dispose) layer.mesh.geometry.dispose();
        }
      };

      // ====== Crear anchors/recursos con carga perezosa ======
      targets.forEach((t) => {
        const anchor = mindarThree.addAnchor(t.index);
        t.anchor = anchor;
        t.layersCreated = false;
        t.layerObjs = [];
        t.audioObj = null;
        t.cleanupTimeout = null;
        t.particles = null;

        const ensureAudio = () => {
          if (t.audioObj) return;
          const audio = new Audio(pickAAC(t.audioBase));
          audio.loop = true;
          audio.preload = "auto";
          audio.crossOrigin = "anonymous";
          t.audioObj = audio;
        };

        const ensureLayers = async () => {
          if (t.layersCreated) return;
          for (const layerCfg of t.layers) {
            const obj = createVideoLayer(layerCfg);
            t.layerObjs.push(obj);
            anchor.group.add(obj.mesh);
            await primeVideoFrame(obj.video); // precalentar
          }
          t.layersCreated = true;
        };

        const ensureParticles = () => {
          if (!ENABLE_PARTICLES) return;
          if (t.particles) return;
          const pcfg = particleMap[t.index];
          if (!pcfg) return;
          const p = Particles[pcfg.type](pcfg.params);
          if (!p) return;
          t.particles = p;
          t.particles.visible = false;
          anchor.group.add(p);
        };

        const showParticles = () => {
          if (t.particles) t.particles.visible = true;
        };
        const hideParticles = () => {
          if (t.particles) t.particles.visible = false;
        };

        anchor.onTargetFound = async () => {
          activeTargets.add(t.index);
          if (t.cleanupTimeout) {
            clearTimeout(t.cleanupTimeout);
            t.cleanupTimeout = null;
          }

          ensureAudio();
          await ensureLayers();
          ensureParticles();

          // Arrancar videos y esperar primer frame de todas las capas
          const waits = [];
          t.layerObjs.forEach(({ video }) => {
            video.play().catch(() => {});
            waits.push(waitFirstFrame(video));
          });
          await Promise.all(waits);

          // Mostrar partículas SOLO después de que el video ya dibujó el primer frame
          showParticles();

          // Reproducir audio si ya se desbloqueó
          if (audioUnlocked && t.audioObj) {
            t.audioObj.muted = false;
            t.audioObj.play().catch(() => {});
          }
        };

        anchor.onTargetLost = () => {
          activeTargets.delete(t.index);
          t.layerObjs.forEach(({ video }) => video.pause());
          hideParticles();
          if (t.audioObj) t.audioObj.pause();
          if (calidad !== "hd") {
            t.cleanupTimeout = setTimeout(() => {
              t.layerObjs.forEach((obj) => {
                anchor.group.remove(obj.mesh);
                disposeLayer(obj);
              });
              t.layerObjs.length = 0;
              t.layersCreated = false;
              if (t.particles) {
                anchor.group.remove(t.particles);
                t.particles.geometry?.dispose?.();
                t.particles.material?.dispose?.();
                t.particles = null;
              }
            }, 5000);
          }
        };
      });

      // ====== Animación de partículas SOLO en targets activos ======
      const animateParticles = () => {
        if (!ENABLE_PARTICLES) return;
        targets.forEach((t) => {
          const p = t.particles;
          if (!p || !p.visible || !activeTargets.has(t.index)) return;
          const positions = p.geometry.attributes.position.array;
          const type = p.userData.type;
          const count = positions.length / 3;
          switch (type) {
            case "rain": {
              const speed = p.userData.speed || 0.005;
              const areaY = p.userData.areaY || 0.5;
              for (let i = 0; i < count; i++) {
                const idx = i * 3;
                positions[idx + 1] -= speed;
                if (positions[idx + 1] < -areaY / 2)
                  positions[idx + 1] = areaY / 2;
              }
              break;
            }
            case "foam": {
              const speed = p.userData.speed || 0.002;
              const areaY = p.userData.areaY || 0.3;
              for (let i = 0; i < count; i++) {
                const idx = i * 3;
                positions[idx + 1] += speed;
                if (positions[idx + 1] > areaY / 2)
                  positions[idx + 1] = -areaY / 2;
              }
              break;
            }
            case "dragonfly": {
              const areaX = p.userData.areaX || 1,
                areaY = p.userData.areaY || 0.3,
                speed = (p.userData.speed || 0.002) * 0.002;
              for (let i = 0; i < count; i++) {
                const idx = i * 3;
                positions[idx] += (Math.random() - 0.5) * speed;
                positions[idx + 1] += (Math.random() - 0.5) * speed;
                positions[idx + 2] += (Math.random() - 0.5) * (speed * 0.5);
                if (positions[idx] > areaX / 2) positions[idx] = areaX / 2;
                if (positions[idx] < -areaX / 2) positions[idx] = -areaX / 2;
                if (positions[idx + 1] > areaY / 2)
                  positions[idx + 1] = areaY / 2;
                if (positions[idx + 1] < -areaY / 2)
                  positions[idx + 1] = -areaY / 2;
              }
              break;
            }
            case "fire": {
              const speed = p.userData.speed || 0.003;
              const areaY = p.userData.areaY || 0.25;
              for (let i = 0; i < count; i++) {
                const idx = i * 3;
                positions[idx + 1] += speed;
                if (positions[idx + 1] > areaY) positions[idx + 1] = 0;
              }
              break;
            }
          }
          p.geometry.attributes.position.needsUpdate = true;
        });
      };

      // ====== Desbloqueo de AUDIO (solo una vez) ======
      const unlockAudioOnce = () => {
        if (audioUnlocked) return;
        audioUnlocked = true;
        targets.forEach((t) => {
          if (!t.audioObj) {
            try {
              t.audioObj = new Audio(pickAAC(t.audioBase));
              t.audioObj.loop = true;
              t.audioObj.preload = "auto";
            } catch (e) {}
          }
          // Desbloqueo silencioso sin pausar música más adelante
          try {
            t.audioObj.muted = true;
            t.audioObj
              .play()
              .then(() => {
                t.audioObj.pause();
                t.audioObj.currentTime = 0;
                t.audioObj.muted = false;
              })
              .catch(() => {});
          } catch (e) {}
        });
      };
      addEventListener("touchstart", unlockAudioOnce, {
        once: true,
        capture: true,
      });
      addEventListener("pointerdown", unlockAudioOnce, {
        once: true,
        capture: true,
      });

      // ====== Splash (icono) ======
      const splash = document.getElementById("splash");
      const splashIcon = document.getElementById("splash-icon");
      splashIcon.style.backgroundImage = `url('${SPLASH_ICON_URL}')`;
      const showSplash = () => {
        splash.classList.add("show");
      };
      const hideSplash = () => {
        splash.classList.remove("show");
        setTimeout(() => splash.remove(), 250);
      };
      splash.addEventListener(
        "pointerdown",
        () => {
          unlockAudioOnce();
          hideSplash();
        },
        { passive: true }
      );
      splash.addEventListener(
        "touchstart",
        () => {
          unlockAudioOnce();
          hideSplash();
        },
        { passive: true }
      );

      // ====== Inicio inmediato de cámara/AR ======
      const fpsBox = document.getElementById("fps");
      const start = async () => {
        await mindarThree.start();
        showSplash();
        setTimeout(hideSplash, SPLASH_DURATION_MS);
        let last = performance.now();
        let frames = 0;
        renderer.setAnimationLoop(() => {
          animateParticles();
          renderer.render(scene, camera);
          frames++;
          const now = performance.now();
          if (now - last >= 1000) {
            fpsBox.textContent = `${frames} fps`;
            frames = 0;
            last = now;
          }
        });
      };
      start();
    </script>
  </body>
</html>
