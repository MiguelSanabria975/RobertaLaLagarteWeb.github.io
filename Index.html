<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>MindAR WebAR Multicapas + Multitarget</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-three.prod.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #ar-container {
        width: 100vw;
        height: 100vh;
        position: relative;
      }
    </style>
  </head>
  <body>
    <div id="ar-container"></div>

    <script type="module">
      const makeChromaMaterial = (texture, key = 0x0f00da) => {
        const col = new THREE.Color(key);
        return new THREE.ShaderMaterial({
          uniforms: {
            map: { value: texture },
            keyColor: { value: col },
            similarity: { value: 0.35 },
            smoothness: { value: 0.1 },
          },
          transparent: true,
          vertexShader: `
            varying vec2 vUv;
            void main() {
              vUv = uv;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
            }
          `,
          fragmentShader: `
            uniform sampler2D map;
            uniform vec3 keyColor;
            uniform float similarity;
            uniform float smoothness;
            varying vec2 vUv;
            void main() {
              vec4 tex = texture2D(map, vUv);
              float Y = dot(tex.rgb, vec3(0.2989, 0.5866, 0.1145));
              float Cr = tex.r - Y;
              float Cb = tex.b - Y;
              float Yk = dot(keyColor.rgb, vec3(0.2989,0.5866,0.1145));
              float Crk = keyColor.r - Yk;
              float Cbk = keyColor.b - Yk;
              float diff = distance(vec2(Cr,Cb), vec2(Crk,Cbk));
              float alpha = smoothstep(similarity, similarity+smoothness, diff);
              gl_FragColor = vec4(tex.rgb, alpha);
            }
          `,
        });
      };

      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.querySelector("#ar-container"),
        imageTargetSrc: "TargetsMind/MultiTarget.mind",
      });

      const { renderer, scene, camera } = mindarThree;

      // Definir los targets y sus capas de video
      const targets = [
        {
          index: 0,
          layers: [
            { src: "Animations/PruebaFondo.mp4", z: -0.02, chroma: false }, // video background
            { src: "Animations/PruebaFrente.mp4", z: 0.2, chroma: true }, // video del personaje principales
            //  { src: "Animations/.mp4", z: 0.02, chroma: true } // video de elementos extras
          ],
        },
        {
          index: 1,
          layers: [
            { src: "Animations/PruebaFondo.mp4", z: -0.02, chroma: false }, // video background
            { src: "Animations/PruebaFrente.mp4", z: 0.2, chroma: true }, // video del personaje principales
            //  { src: "Animations/.mp4", z: 0.02, chroma: true } // video de elementos extras
          ],
        },
      ];

      // Iterar sobre cada target y sus capas
      targets.forEach(({ index, layers }) => {
        const anchor = mindarThree.addAnchor(index);
        const videos = [];

        layers.forEach(({ src, z, chroma }) => {
          const video = document.createElement("video");
          video.src = src;
          video.crossOrigin = "anonymous";
          video.loop = true;
          video.muted = true;
          video.playsInline = true;
          videos.push(video);

          const texture = new THREE.VideoTexture(video);
          const geometry = new THREE.PlaneGeometry(1, 0.7);
          const material = chroma
            ? makeChromaMaterial(texture, 0x0f00da)
            : new THREE.MeshBasicMaterial({ map: texture });

          const plane = new THREE.Mesh(geometry, material);
          plane.position.z = z;
          anchor.group.add(plane);
        });

        anchor.onTargetFound = () => {
          videos.forEach((v) => v.play());
        };

        anchor.onTargetLost = () => {
          videos.forEach((v) => v.pause());
        };
      });

      const start = async () => {
        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      };

      start();
    </script>
  </body>
</html>
